<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>GALAXY FURNITURE - QU·∫¢N L√ù XU·∫§T NH·∫¨P KHO</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #FF6600;
      color: white;
    }
    h2 { text-align: center; }
    .form-container {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 8px;
      max-width: 1100px;
      margin: auto;
      position: relative;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      margin: 5px;
    }
    label { margin-bottom: 3px; font-size: 14px; }
    input, select {
      padding: 6px;
      border: none;
      border-radius: 4px;
      color: black;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      border-bottom: 1px dashed #fff;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }
    .row .form-group { flex: 1; min-width: 120px; }
    .short { max-width: 80px; }
    .tiny { max-width: 100px; }
    .wide { min-width: 250px; }
    .actions { display: flex; gap: 10px; margin-top: 10px; }
    button {
      padding: 8px 12px;
      background: #222;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #444; }
    #status { margin-top: 15px; font-weight: bold; }
    #webhook-section {
      margin-bottom: 15px;
      background: rgba(255,255,255,0.15);
      padding: 10px;
      border-radius: 6px;
      max-width: 400px;
    }
    #toggleWebhook {
      cursor: pointer;
      background: none;
      border: none;
      color: white;
      font-size: 14px;
    }
    /* H√†ng ch·ª©a T√™n ng∆∞·ªùi nh·∫≠p + n√∫t g·ª≠i */
    .submit-row {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }
    .submit-row input {
      width: 200px;
    }
  </style>
</head>
<body>
  <h2>GALAXY FURNITURE - QU·∫¢N L√ù XU·∫§T NH·∫¨P KHO</h2>

  <div class="form-container">
    <!-- Webhook -->
    <div id="webhook-section">
      <button id="toggleWebhook">‚ñº Webhook n8n (POST)</button>
      <div id="webhookInputs" style="display:none; margin-top:10px;">
        <input type="text" id="webhookUrl" placeholder="D√°n link webhook t·∫°i ƒë√¢y" style="width:100%">
        <button id="saveWebhook">üíæ L∆∞u Webhook</button>
      </div>
    </div>

    <!-- Ph·∫ßn ch·ªçn chung -->
    <div class="row">
      <div class="form-group">
        <label>H√†nh ƒë·ªông</label>
        <select id="hanhdong" onchange="toggleLayout()" required>
          <option value="nhap">Nh·∫≠p kho</option>
          <option value="xuat">Xu·∫•t kho</option>
        </select>
      </div>
      <div class="form-group wide">
        <label>Kh√°ch h√†ng</label>
        <select id="khachhang"></select>
      </div>
      <div class="form-group">
        <label>Lo·∫°i v·∫≠t t∆∞</label>
        <select id="loaivattu"></select>
      </div>
      <!-- √î Nh√† cung c·∫•p -->
      <div class="form-group wide">
        <label>Nh√† cung c·∫•p</label>
        <select id="nhacungcap"></select>
      </div>
    </div>

    <!-- Layout nh·∫≠p kho -->
    <div id="layoutNhap">
      <div id="formNhap"></div>
      <div class="actions">
        <button type="button" onclick="addRow('nhap')">‚ûï Th√™m d√≤ng nh·∫≠p</button>
      </div>
    </div>

    <!-- Layout xu·∫•t kho -->
    <div id="layoutXuat" style="display:none;">
      <div id="formXuat"></div>
      <div class="actions">
        <button type="button" onclick="addRow('xuat')">‚ûï Th√™m d√≤ng xu·∫•t</button>
      </div>
    </div>

    <form id="inventoryForm">
      <!-- √î T√™n ng∆∞·ªùi nh·∫≠p + n√∫t g·ª≠i c√πng h√†ng -->
      <div class="submit-row">
        <input type="text" id="tennguoinhap" placeholder="T√™n ng∆∞·ªùi nh·∫≠p">
        <button type="submit" class="submit-btn">üì© Nh·∫≠p d·ªØ li·ªáu</button>
      </div>
    </form>

    <p id="status"></p>
  </div>

  <!-- Gi·ªØ nguy√™n ph·∫ßn JS -->
  <script>
    const khachHangList = [
      "", // option tr·ªëng
      "ROVECONCEPTS","ROVECONCEPTS CB2","BEALLS","BURLINGTON","CLI FURNITURE",
      "KIRKLAND","BLUEROCK SILC","BLUEROCK SULLIVAN","ROYAL DESIGN",
      "TRENDRUM","VENTURE HOME","PROVINCIAL HOME"
    ];
    const vatTuList = [
      "", // option tr·ªëng
      "V·∫¨T T∆Ø NG≈® KIM","V·∫¨T T∆Ø METAL","ƒê√Å","GIA C√îNG H√ÄNG TR·∫ÆNG","N·ªÜM",
      "BAO B√å CARTON","M√öT X·ªêP","TEM NH√ÉN (LABEL)","NGUY√äN LI·ªÜU","U·ªêN CONG",
      "S∆†N","V·∫¨T T∆Ø NGO√ÄI ƒê·ªäNH M·ª®C"
    ];
    const nhaCungCapList = [
      "", // option tr·ªëng
      "BB MINH KHANG","BB NAM THANH","BB NAM LONG","H√Ä B·∫ÆC","NH·∫¨T NAM","T√ÇN HO√ÄNG SANG",
      "TH√ÅI B√åNH D∆Ø∆†NG","ECO","HO√ÄNG HO√ÄNG LINH","H·∫¢I V√ÇN KH√ÅNH","M·∫†NH NH∆Ø PHONG",
      "SOFA QL","SOFA MINH H·∫†O","T√ÇM T√ÄI","NH√ÅM H·ªíNG PH√ö","GIA MINH C√ÅT"
    ];

    const webhookUrlInput = document.getElementById("webhookUrl");
    const khachhangSelect = document.getElementById("khachhang");
    const loaivattuSelect = document.getElementById("loaivattu");
    const nhacungcapSelect = document.getElementById("nhacungcap");

    khachHangList.forEach(k => {
      let opt = document.createElement("option");
      opt.value = k; opt.textContent = k;
      khachhangSelect.appendChild(opt);
    });
    vatTuList.forEach(v => {
      let opt = document.createElement("option");
      opt.value = v; opt.textContent = v;
      loaivattuSelect.appendChild(opt);
    });
    nhaCungCapList.forEach(n => {
      let opt = document.createElement("option");
      opt.value = n; opt.textContent = n;
      nhacungcapSelect.appendChild(opt);
    });

    function toggleLayout() {
      const action = document.getElementById("hanhdong").value;
      document.getElementById("layoutNhap").style.display = (action === "nhap") ? "block" : "none";
      document.getElementById("layoutXuat").style.display = (action === "xuat") ? "block" : "none";
    }

    function addRow(type) {
      const container = (type === "nhap") ? document.getElementById("formNhap") : document.getElementById("formXuat");
      const row = document.createElement("div");
      row.className = "row";

      if (type === "nhap") {
        row.innerHTML = `
          <div class="form-group"><label>PO</label><input type="text" name="po"></div>
          <div class="form-group"><label>M√£ v·∫≠t t∆∞</label><input type="text" name="mavattu"></div>
          <div class="form-group short"><label>S·ªë l∆∞·ª£ng</label><input type="number" name="soluong"></div>
          <div class="form-group tiny"><label>L·∫ßn nh·∫≠p</label><input type="number" name="lan"></div>
          <div class="form-group"><label>Ng√†y</label><input type="date" name="ngay"></div>
          <div class="form-group"><label>H√¨nh ·∫£nh</label><input type="file" name="hinhanh" accept="image/*"></div>
          <div class="form-group"><label>&nbsp;</label><button type="button" onclick="this.parentElement.parentElement.remove()">‚ùå X√≥a</button></div>
        `;
      } else {
        row.innerHTML = `
          <div class="form-group"><label>PO</label><input type="text" name="po"></div>
          <div class="form-group"><label>M√£ v·∫≠t t∆∞</label><input type="text" name="mavattu"></div>
          <div class="form-group"><label>M√£ s·∫£n ph·∫©m</label><input type="text" name="masp"></div>
          <div class="form-group short"><label>S·ªë l∆∞·ª£ng</label><input type="number" name="soluong"></div>
          <div class="form-group tiny"><label>L·∫ßn xu·∫•t</label><input type="number" name="lan"></div>
          <div class="form-group"><label>Ng√†y</label><input type="date" name="ngay"></div>
          <div class="form-group"><label>H√¨nh ·∫£nh</label><input type="file" name="hinhanh" accept="image/*"></div>
          <div class="form-group"><label>&nbsp;</label><button type="button" onclick="this.parentElement.parentElement.remove()">‚ùå X√≥a</button></div>
        `;
      }

      container.appendChild(row);
    }

    document.getElementById("toggleWebhook").addEventListener("click", () => {
      const section = document.getElementById("webhookInputs");
      section.style.display = section.style.display === "none" ? "block" : "none";
    });

    document.getElementById("saveWebhook").addEventListener("click", () => {
      const url = webhookUrlInput.value.trim();
      if (!url) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p webhook tr∆∞·ªõc khi l∆∞u!");
        return;
      }
      localStorage.setItem("webhookUrl", url);
      alert("‚úÖ Webhook ƒë√£ ƒë∆∞·ª£c l∆∞u!");
    });

    window.addEventListener("load", () => {
      const savedWebhook = localStorage.getItem("webhookUrl");
      if (savedWebhook) webhookUrlInput.value = savedWebhook;
      addRow("nhap");
    });

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    document.getElementById("inventoryForm").addEventListener("submit", async function(e){
      e.preventDefault();

      const webhookUrl = webhookUrlInput.value.trim() || localStorage.getItem("webhookUrl");
      if (!webhookUrl) {
        alert("‚ö†Ô∏è Ch∆∞a c√≥ webhook. Vui l√≤ng nh·∫≠p ho·∫∑c l∆∞u webhook tr∆∞·ªõc!");
        return;
      }

      const hanhdong = document.getElementById("hanhdong").value;
      const khachhang = document.getElementById("khachhang").value;
      const loaivattu = document.getElementById("loaivattu").value;
      const nhacungcap = document.getElementById("nhacungcap").value;
      const tennguoinhap = document.getElementById("tennguoinhap").value;

      const rows = (hanhdong === "nhap")
        ? document.querySelectorAll("#formNhap .row")
        : document.querySelectorAll("#formXuat .row");

      const data = [];
      for (let r of rows) {
        let fileInput = r.querySelector('[name="hinhanh"]');
        let fileData = null;
        if (fileInput && fileInput.files.length > 0) {
          fileData = await toBase64(fileInput.files[0]);
        }

        const rowData = {
          hanhdong,
          khachhang,
          loaivattu,
          nhacungcap,
          tennguoinhap,
          po: r.querySelector('[name="po"]').value,
          ma_vattu: r.querySelector('[name="mavattu"]').value,
          so_luong: parseInt(r.querySelector('[name="soluong"]').value),
          lan: parseInt(r.querySelector('[name="lan"]').value),
          ngay: r.querySelector('[name="ngay"]').value,
          hinhanh: fileData
        };

        if (hanhdong === "xuat") {
          rowData.ma_sp = r.querySelector('[name="masp"]').value;
        }

        data.push(rowData);
      }

      try {
        let res = await fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        document.getElementById("status").innerText = res.ok
          ? "‚úÖ G·ª≠i th√†nh c√¥ng"
          : "‚ùå L·ªói khi g·ª≠i";
      } catch (err) {
        document.getElementById("status").innerText = "‚ùå L·ªói k·∫øt n·ªëi";
      }
    });
  </script>
</body>
</html>
